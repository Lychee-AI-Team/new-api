# New API 技术架构设计文档

## 一、项目概述

### 1.1 项目简介
New API 是新一代大模型网关与AI资产管理系统，基于 One API 二次开发。项目采用前后端分离架构，提供统一的 API 接口管理、渠道分发、计费管理等功能。

### 1.2 技术选型总览
- **前端技术栈**：React + Vite + Semi UI
- **后端技术栈**：Go + Gin + GORM
- **数据库**：SQLite / MySQL / PostgreSQL
- **缓存**：Redis
- **容器化**：Docker + Docker Compose
- **部署方式**：单机部署 / 集群部署

---

## 二、后端架构设计

### 2.1 技术栈详解

#### 2.1.1 核心框架
- **Web框架**：Gin 1.9.1
  - 高性能HTTP框架
  - 支持中间件机制
  - JSON验证和自动绑定

#### 2.1.2 数据层
- **ORM框架**：GORM 1.25.2
  - 支持MySQL、PostgreSQL、SQLite
  - 数据库迁移和模型定义
  - 关联查询和事务支持

- **数据库驱动**
  - `gorm.io/driver/mysql` v1.4.3
  - `gorm.io/driver/postgres` v1.5.2
  - `github.com/glebarez/sqlite` v1.9.0（纯Go实现）

#### 2.1.3 缓存与存储
- **Redis客户端**：`go-redis/redis/v8` v8.11.5
  - 渠道缓存
  - 用户会话管理
  - 数据库同步缓存

#### 2.1.4 认证与安全
- **JWT认证**：`golang-jwt/jwt/v5` v5.3.0
- **WebAuthn**：`go-webauthn/webauthn` v0.14.0
- **OTP**：`pquerna/otp` v1.5.0（双因素认证）
- **加密**：`golang.org/x/crypto` v0.45.0

#### 2.1.5 实时通信
- **WebSocket**：`gorilla/websocket` v1.5.0
  - SSE流式响应
  - 实时日志推送
  - WebSocket代理

#### 2.1.6 媒体处理
- **音频处理**
  - `go-audio/wav` v1.1.0
  - `go-audio/aiff` v1.1.0
  - `jfreymuth/oggvorbis` v1.0.5
  - `tcolgate/mp3` v0.0.0-20170426193717
  - `mewkiz/flac` v1.0.13

- **视频处理**
  - `abema/go-mp4` v1.4.1
  - `yapingcat/gomedia` v0.0.0-20240906162731

- **图片处理**
  - `golang.org/x/image` v0.23.0

#### 2.1.7 请求处理
- **HTTP客户端**：自定义封装
- **压缩**：`klauspost/compress` v1.17.8
- **Brotli**：`andybalholm/brotli` v1.1.1

#### 2.1.8 监控与性能
- **Pyroscope**：`grafana/pyroscope-go` v1.2.7
  - 持续性能分析
  - CPU和内存profiling
  - 支持`pprof`调试

#### 2.1.9 其他工具库
- **配置管理**：`joho/godotenv` v1.5.1
- **UUID生成**：`google/uuid` v1.6.0
- **JSON处理**：`tidwall/gjson` v1.18.0、`tidwall/sjson` v1.2.5
- **深拷贝**：`jinzhu/copier` v0.4.0
- **数学计算**：`shopspring/decimal` v1.4.0（精确数值计算）
- **错误处理**：`pkg/errors` v0.9.1
- **系统监控**：`shirou/gopsutil` v3.21.11
- **并发池**：`bytedance/gopkg` v0.1.3（gopool）
- **Token计数**：`tiktoken-go/tokenizer` v0.6.2

#### 2.1.10 支付集成
- **Stripe**：`stripe/stripe-go/v81` v81.4.0
- **易支付**：`Calcium-Ion/go-epay` v0.0.4

#### 2.1.11 云服务SDK
- **AWS Bedrock**：`aws-sdk-go-v2` v1.37.2
  - Amazon Bedrock Runtime v1.33.0
  - AWS Credentials v1.17.11

### 2.2 项目结构

```
new-api/
├── main.go                 # 应用入口
├── controller/            # 控制器层（HTTP接口处理）
│   ├── channel.go         # 渠道管理
│   ├── user.go            # 用户管理
│   ├── token.go           # Token管理
│   ├── model.go           # 模型管理
│   ├── log.go             # 日志管理
│   ├── relay.go           # API中继
│   ├── topup.go           # 充值管理
│   ├── task.go            # 任务管理
│   ├── midjourney.go      # Midjourney任务
│   └── ...
├── model/                 # 数据模型层
│   ├── user.go            # 用户模型
│   ├── token.go           # Token模型
│   ├── channel.go         # 渠道模型
│   ├── option.go          # 配置模型
│   ├── log.go             # 日志模型
│   ├── ability.go         # 能力模型
│   ├── channel_cache.go   # 渠道缓存
│   ├── pricing.go         # 价格配置
│   └── ...
├── service/               # 业务逻辑层
│   ├── channel_select.go  # 渠道选择
│   ├── convert.go         # 格式转换
│   ├── quota.go           # 额度管理
│   ├── token_counter.go   # Token计数
│   ├── token_estimator.go # Token估算
│   ├── audio.go           # 音频处理
│   ├── image.go           # 图片处理
│   ├── codex_oauth.go     # Codex OAuth
│   ├── webhook.go         # Webhook
│   └── ...
├── relay/                 # API中继模块
│   ├── channel/           # 各厂商适配器
│   │   ├── openai/        # OpenAI适配
│   │   ├── claude/        # Claude适配
│   │   ├── gemini/        # Gemini适配
│   │   ├── vertex/        # Vertex AI适配
│   │   ├── ali/           # 阿里云适配
│   │   ├── baidu_v2/      # 百度适配
│   │   ├── mistral/       # Mistral适配
│   │   ├── ollama/        # Ollama适配
│   │   ├── jina/          # Jina适配
│   │   ├── dify/          # Dify适配
│   │   ├── palm/          # PaLM适配
│   │   └── volcengine/    # 火山引擎适配
│   ├── compatible_handler.go   # 兼容性处理
│   ├── chat_completions_via_responses.go  # Responses API
│   ├── claude_handler.go         # Claude处理器
│   ├── gemini_handler.go         # Gemini处理器
│   ├── embedding_handler.go      # Embedding处理器
│   ├── image_handler.go          # 图像生成处理器
│   ├── rerank_handler.go         # Rerank处理器
│   ├── audio_handler.go          # 音频处理器
│   ├── mjproxy_handler.go        # MJ Proxy处理器
│   ├── websocket.go              # WebSocket处理
│   └── helper/                   # 辅助工具
│       ├── price.go              # 价格计算
│       ├── stream_scanner.go     # 流式扫描
│       ├── model_mapped.go       # 模型映射
│       └── ...
├── middleware/            # 中间件
│   ├── auth.go           # 认证中间件
│   ├── rate_limit.go     # 限流中间件
│   ├── cors.go           # CORS中间件
│   ├── logger.go         # 日志中间件
│   └── ...
├── router/               # 路由配置
│   ├── main.go           # 主路由
│   ├── api-router.go     # API路由
│   ├── web-router.go     # Web路由
│   ├── relay-router.go   # 中继路由
│   └── video-router.go   # 视频路由
├── dto/                  # 数据传输对象
├── common/               # 公共工具
├── constant/             # 常量定义
├── setting/              # 配置管理
├── logger/               # 日志模块
├── types/                # 类型定义
└── web/                  # 前端静态资源
```

### 2.3 核心功能模块

#### 2.3.1 路由层（Router）
- **API路由**：`/api/*` - 管理接口
- **中继路由**：`/v1/*` - OpenAI兼容接口
- **视频路由**：`/pg/*` - 视频代理
- **Web路由**：`/` - 前端页面（SPA）

#### 2.3.2 控制器层（Controller）
处理HTTP请求，调用业务逻辑层：
- 用户认证与管理
- Token令牌管理
- 渠道配置与测试
- 模型管理
- 日志查询
- 充值与支付
- 任务调度
- OAuth授权（Discord、LinuxDO、Telegram、GitHub）
- OIDC统一认证
- Passkey/WebAuthn认证
- 双因素认证（2FA）

#### 2.3.3 业务逻辑层（Service）
核心业务处理：
- **渠道选择**：根据权重、状态、能力选择最优渠道
- **格式转换**：不同API格式之间的转换（OpenAI ↔ Claude ↔ Gemini）
- **额度管理**：Token计数、费用计算、预消费
- **Token处理**：精确计数、估算、编码
- **媒体处理**：音频编解码、图片处理、文件下载
- **OAuth服务**：Codex OAuth认证流程
- **Webhook**：事件通知
- **敏感词过滤**：内容安全

#### 2.3.4 数据模型层（Model）
- **User**：用户信息
- **Token**：API令牌
- **Channel**：AI渠道配置
- **Ability**：模型能力映射
- **Log**：调用日志
- **Option**：系统配置
- **Pricing**：价格配置
- **Redemption**：兑换码
- **Topup**：充值记录
- **Task**：异步任务
- **Midjourney**：MJ任务

#### 2.3.5 中继层（Relay）
多厂商AI接口适配：
- **OpenAI系列**：GPT-4、GPT-3.5、Responses API、Realtime API
- **Anthropic**：Claude Messages API
- **Google**：Gemini API
- **Azure**：Azure OpenAI Service
- **阿里云**：通义千问
- **百度**：文心一言
- **Mistral**：Mistral AI
- **Ollama**：本地模型
- **Jina**：Embedding和Rerank
- **Dify**：Dify工作流
- **PaLM**：Google PaLM
- **Vertex AI**：Google Vertex
- **火山引擎**：豆包
- **Midjourney Proxy**：图像生成
- **Suno API**：音乐生成

支持的接口类型：
- Chat Completions（聊天补全）
- Responses（响应接口）
- Images（图像生成）
- Audio（语音转文字/文字转语音）
- Embeddings（文本嵌入）
- Rerank（重排序）
- Realtime（实时对话）
- Video（视频生成）

### 2.4 数据流架构

```
客户端请求
    ↓
[Middleware] - 认证、限流、日志
    ↓
[Router] - 路由分发
    ↓
[Controller] - 请求验证
    ↓
[Service] - 业务逻辑处理
    ↓
[Model] - 数据持久化
    ↓
[Relay] - API中继至第三方
    ↓
[Channel Adapter] - 厂商适配
    ↓
第三方AI服务
```

### 2.5 缓存策略

#### 2.5.1 Redis缓存
- 渠道缓存（`channel_cache.go`）
- 用户缓存（`user_cache.go`）
- Token缓存（`token_cache.go`）
- 会话管理

#### 2.5.2 内存缓存
- 渠道同步缓存
- 能力映射缓存
- 价格配置缓存

#### 2.5.3 缓存同步
- 定时同步（可配置频率）
- 实时更新机制
- 缓存失效策略

### 2.6 部署架构

#### 2.6.1 单机部署
```
┌─────────────────────────────┐
│         Docker容器          │
│  ┌─────────────────────┐    │
│  │   New API (Go)      │    │
│  │   - API Server      │    │
│  │   - Static Files    │    │
│  └─────────────────────┘    │
│         ↓                    │
│  ┌─────────────────────┐    │
│  │   SQLite /data       │    │
│  └─────────────────────┘    │
└─────────────────────────────┘
```

#### 2.6.2 分布式部署
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ New API    │    │ New API    │    │ New API    │
│ Instance 1  │    │ Instance 2  │    │ Instance N  │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       └──────────────────┼──────────────────┘
                          ↓
                 ┌────────────────┐
                 │ Load Balancer  │
                 └────────┬───────┘
                          ↓
       ┌──────────────────┼──────────────────┐
       ↓                  ↓                  ↓
┌────────────┐    ┌────────────┐    ┌────────────┐
│   Redis    │    │ PostgreSQL │    │ PostgreSQL │
│  Cluster   │    │  Primary   │    │  Replica   │
└────────────┘    └────────────┘    └────────────┘
```

### 2.7 环境变量配置

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `PORT` | 服务端口 | 3000 |
| `SQL_DSN` | 数据库连接字符串 | - |
| `REDIS_CONN_STRING` | Redis连接字符串 | - |
| `SESSION_SECRET` | 会话密钥（多机部署必须） | - |
| `CRYPTO_SECRET` | 加密密钥（Redis必须） | - |
| `STREAMING_TIMEOUT` | 流式超时时间（秒） | 300 |
| `STREAM_SCANNER_MAX_BUFFER_MB` | 流式扫描器最大缓冲 | 64 |
| `MAX_REQUEST_BODY_MB` | 请求体最大大小 | 32 |
| `SYNC_FREQUENCY` | 缓存同步频率（秒） | 60 |
| `BATCH_UPDATE_ENABLED` | 批量更新开关 | false |
| `ERROR_LOG_ENABLED` | 错误日志开关 | false |
| `FRONTEND_BASE_URL` | 前端地址（分离部署） | - |
| `PYROSCOPE_URL` | Pyroscope服务地址 | - |
| `GOOGLE_ANALYTICS_ID` | Google Analytics ID | - |
| `UMAMI_WEBSITE_ID` | Umami网站ID | - |

---

## 三、前端架构设计

### 3.1 技术栈详解

#### 3.1.1 核心框架
- **React**：18.2.0
  - Hooks API
  - 函数式组件
  - Context API状态管理

#### 3.1.2 构建工具
- **Vite**：5.2.0
  - 快速的模块热更新（HMR）
  - 基于ESBuild的极速构建
  - 原生ES模块支持

#### 3.1.3 UI组件库
- **Semi UI**：@douyinfe/semi-ui v2.69.1
  - 字节跳动开源企业级UI组件
  - TypeScript支持
  - 主题定制

- **Ant Design**：5.23.0
  - 企业级UI设计语言
  - 丰富的组件库

- **图标库**
  - @douyinfe/semi-icons v2.63.1
  - @douyinfe/semi-illustrations v2.0.0
  - @lobehub/icons v2.48.0
  - react-icons v5.5.0
  - lucide-react v0.511.0

#### 3.1.4 路由
- **React Router DOM**：6.3.0
  - 声明式路由
  - 路由守卫
  - 嵌套路由

#### 3.1.5 状态管理
- **Context API**：React原生状态管理
- **Hooks**：自定义Hooks封装
- **use-debounce**：v10.0.4（防抖）

#### 3.1.6 国际化（i18n）
- **i18next**：v23.16.8
- **react-i18next**：v13.0.0
- **i18next-browser-languagedetector**：v7.2.0

支持语言：
- 中文（简体）
- English
- Français
- 日本語

#### 3.1.7 HTTP客户端
- **Axios**：1.12.0
  - 请求/响应拦截器
  - 取消请求
  - 超时处理
  - 自动JSON转换

#### 3.1.8 数据可视化
- **VChart**：@visactor/react-vchart v1.8.8
  - 高性能图表库
  - Semi UI主题适配

#### 3.1.9 内容渲染
- **Markdown渲染**
  - marked v4.1.1
  - react-markdown v10.1.0
  - remark-gfm v4.0.1（GitHub Flavored Markdown）
  - remark-breaks v4.0.0（换行支持）
  - remark-math v6.0.0（数学公式）

- **代码高亮**
  - highlight.js v11.9.0
  - rehype-highlight v7.0.2

- **数学公式**
  - katex v0.16.22
  - rehype-katex v7.0.1

- **流程图**
  - mermaid v11.6.0

#### 3.1.10 工具库
- **日期处理**：dayjs v1.11.11
- **字符串操作**：clsx v2.1.1
- **历史管理**：history v5.3.0
- **二维码**：qrcode.react v4.2.0
- **文件上传**：react-dropzone v14.2.3
- **通知**：react-toastify v9.0.8
- **验证码**：react-turnstile v1.0.5（Cloudflare Turnstile）
- **Telegram登录**：react-telegram-login v1.1.2
- **特效**：react-fireworks v1.0.4
- **SSE**：sse.js v2.6.0（Server-Sent Events）

#### 3.1.11 开发工具
- **TypeScript**：4.4.2
- **ESLint**：8.57.0
- **Prettier**：3.0.0
- **Tailwind CSS**：3
- **PostCSS**：8.5.3
- **Autoprefixer**：10.4.21

#### 3.1.12 Vite插件
- @vitejs/plugin-react：4.2.1
- @douyinfe/vite-plugin-semi：2.74.0-alpha.6
- code-inspector-plugin：1.3.3（代码检查器）

### 3.2 项目结构

```
web/
├── index.html              # HTML入口
├── package.json            # 依赖配置
├── vite.config.js          # Vite配置
├── tailwind.config.js      # Tailwind配置
├── postcss.config.js       # PostCSS配置
├── i18next.config.js       # i18n配置
├── public/                 # 静态资源
│   └── logo.png
├── src/
│   ├── index.jsx           # React入口
│   ├── index.css           # 全局样式
│   ├── App.jsx             # 根组件
│   ├── components/         # 公共组件
│   │   ├── Layout/         # 布局组件
│   │   ├── Header/         # 头部组件
│   │   ├── Sidebar/        # 侧边栏
│   │   ├── Table/          # 表格组件
│   │   ├── Form/           # 表单组件
│   │   ├── Modal/          # 模态框
│   │   └── ...
│   ├── pages/              # 页面组件
│   │   ├── Dashboard/      # 数据看板
│   │   ├── Channel/        # 渠道管理
│   │   ├── Token/          # Token管理
│   │   ├── User/           # 用户管理
│   │   ├── Model/          # 模型管理
│   │   ├── Log/            # 日志查询
│   │   ├── TopUp/          # 充值管理
│   │   ├── Task/           # 任务管理
│   │   ├── Midjourney/     # MJ任务
│   │   ├── Chat/           # 聊天界面
│   │   ├── Playground/     # API测试
│   │   ├── Setting/        # 系统设置
│   │   │   ├── About/      # 关于
│   │   │   ├── Operation/  # 运营设置
│   │   │   ├── System/     # 系统配置
│   │   │   └── ...
│   │   ├── Pricing/        # 价格配置
│   │   ├── Redemption/    # 兑换码
│   │   ├── ModelDeployment/# 模型部署
│   │   ├── Chat2Link/      # 聊天链接
│   │   ├── Setup/          # 初始化
│   │   └── ...
│   ├── contexts/           # Context上下文
│   │   └── GlobalContext.jsx
│   ├── hooks/              # 自定义Hooks
│   │   ├── useApi.js       # API调用
│   │   ├── useAuth.js      # 认证
│   │   ├── useChannel.js   # 渠道
│   │   ├── useToken.js     # Token
│   │   └── ...
│   ├── services/           # API服务
│   │   └── API.js          # Axios封装
│   ├── helpers/            # 辅助函数
│   │   ├── format.js       # 格式化
│   │   ├── validation.js   # 验证
│   │   └── ...
│   ├── constants/          # 常量定义
│   │   └── index.js
│   └── i18n/               # 国际化
│       ├── zh.json         # 中文
│       ├── en.json         # 英文
│       └── ...
└── dist/                   # 构建输出（嵌入后端）
```

### 3.3 核心功能模块

#### 3.3.1 页面模块

**Dashboard（数据看板）**
- 数据可视化图表
- 实时统计数据
- 用户使用趋势
- 渠道调用统计

**Channel（渠道管理）**
- 渠道列表
- 渠道添加/编辑/删除
- 渠道测试
- 批量导入/导出
- 渠道状态监控

**Token（令牌管理）**
- Token列表
- Token创建/编辑
- 权限配置
- 限额设置
- 访问统计

**User（用户管理）**
- 用户列表
- 用户添加/编辑
- 权限管理
- 用户组管理
- 充值记录

**Model（模型管理）**
- 模型列表
- 能力配置
- 价格设置
- 模型映射

**Log（日志查询）**
- 调用日志
- 日志筛选
- 导出功能
- 详细查看

**TopUp（充值管理）**
- 充值记录
- 支付配置
- 充值码管理

**Task（任务管理）**
- 异步任务
- 任务状态
- 重试机制

**Midjourney（MJ任务）**
- MJ任务列表
- 图片预览
- 下载管理

**Chat（聊天界面）**
- 多模型切换
- 流式输出
- Markdown渲染
- 历史记录

**Playground（API测试）**
- 接口测试
- 参数配置
- 响应查看

**Setting（系统设置）**
- 运营设置
- 系统配置
- 支付设置
- 通知设置
- 关于页面

#### 3.3.2 组件模块

**Layout**
- 主布局
- 侧边栏导航
- 顶部栏

**Table**
- 通用数据表格
- 排序/筛选
- 分页

**Form**
- 表单组件
- 验证规则

**Modal**
- 模态框
- 确认对话框

**Loading**
- 加载状态
- 骨架屏

**Markdown**
- Markdown渲染器
- 代码高亮
- 数学公式

### 3.4 状态管理

#### 3.4.1 全局状态
```javascript
// GlobalContext.jsx
const GlobalContext = {
  user: {},           // 用户信息
  token: '',          // 认证Token
  isAdmin: false,     // 管理员标识
  theme: 'light',     // 主题
  language: 'zh',     // 语言
}
```

#### 3.4.2 自定义Hooks
- `useAuth()`：认证状态管理
- `useApi()`：API调用封装
- `useChannel()`：渠道数据管理
- `useToken()`：Token管理
- `useUser()`：用户管理
- `useModel()`：模型管理

### 3.5 API服务封装

#### 3.5.1 Axios配置
```javascript
// services/API.js
- 基础URL配置
- 请求拦截器（添加Token）
- 响应拦截器（错误处理）
- 超时设置
- 重试机制
```

#### 3.5.2 API模块
- 用户相关API
- 渠道相关API
- Token相关API
- 模型相关API
- 日志相关API
- 充值相关API
- 系统配置API

### 3.6 路由配置

```javascript
// react-router-dom v6
/
  ├── /login              # 登录
  ├── /register           # 注册
  ├── /setup              # 初始化
  ├── /
  │   ├── /dashboard      # 数据看板
  │   ├── /channel        # 渠道管理
  │   ├── /token          # Token管理
  │   ├── /user           # 用户管理
  │   ├── /model          # 模型管理
  │   ├── /log            # 日志查询
  │   ├── /topup          # 充值管理
  │   ├── /task           # 任务管理
  │   ├── /midjourney     # MJ任务
  │   ├── /chat           # 聊天
  │   ├── /playground     # API测试
  │   ├── /pricing        # 价格配置
  │   ├── /redemption     # 兑换码
  │   ├── /deployment     # 模型部署
  │   └── /setting        # 系统设置
  │       ├── /about      # 关于
  │       ├── /operation  # 运营设置
  │       ├── /system     # 系统配置
  │       └── ...
  ├── /forbidden          # 禁止访问
  └── /*                  # 404
```

### 3.7 构建配置

#### 3.7.1 Vite配置
```javascript
{
  // 路径别名
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src')
    }
  },
  
  // 插件
  plugins: [
    react(),
    codeInspectorPlugin(),
    // vite-plugin-semi（兼容性问题，已禁用）
  ],
  
  // 代码分割
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'react-core': ['react', 'react-dom', 'react-router-dom'],
          'semi-ui': ['@douyinfe/semi-icons', '@douyinfe/semi-ui'],
          'tools': ['axios', 'history', 'marked'],
          'i18n': ['i18next', 'react-i18next', 'i18next-browser-languagedetector'],
        }
      }
    }
  },
  
  // 开发服务器
  server: {
    host: '0.0.0.0',
    proxy: {
      '/api': 'http://localhost:3000',
      '/mj': 'http://localhost:3000',
      '/pg': 'http://localhost:3000'
    }
  }
}
```

#### 3.7.2 构建命令
```bash
# 开发
npm run dev / bun run dev

# 构建
npm run build / bun run build

# 代码检查
npm run lint / bun run eslint

# 代码格式化
npm run lint:fix / bun run eslint:fix

# i18n管理
npm run i18n:extract  # 提取翻译
npm run i18n:sync     # 同步翻译
npm run i18n:status   # 翻译状态
```

### 3.8 样式方案

#### 3.8.1 CSS方案
- **Semi UI CSS**：主要UI组件样式
- **Tailwind CSS**：原子化CSS，快速布局
- **全局CSS**：index.css，全局样式覆盖
- **CSS Modules**：组件级样式隔离

#### 3.8.2 主题配置
- Semi UI主题定制
- Tailwind配置
- 暗黑模式支持

### 3.9 国际化（i18n）

#### 3.9.1 配置
```javascript
// i18next.config.js
{
  lng: 'zh',
  fallbackLng: 'en',
  debug: false,
  
  resources: {
    zh: { translations: {...} },
    en: { translations: {...} },
    fr: { translations: {...} },
    ja: { translations: {...} }
  }
}
```

#### 3.9.2 使用方式
```javascript
import { useTranslation } from 'react-i18next';

const { t } = useTranslation();
return <div>{t('key')}</div>;
```

---

## 四、前后端交互

### 4.1 API接口规范

#### 4.1.1 管理接口（`/api/*`）
- 用户认证
- 资源管理
- 系统配置

#### 4.1.2 中继接口（`/v1/*`）
- OpenAI兼容接口
- Claude Messages接口
- Gemini接口
- Embedding接口
- Rerank接口

#### 4.1.3 代理接口
- `/mj/*`：Midjourney代理
- `/pg/*`：视频代理

### 4.2 认证机制

#### 4.2.1 后端认证
- Cookie会话（Session）
- API Key认证
- JWT Token

#### 4.2.2 前端认证
- Token存储（LocalStorage/SessionStorage）
- 自动刷新Token
- 请求拦截器添加Token

### 4.3 数据传输

#### 4.3.1 请求格式
```javascript
// JSON格式
{
  "key": "value",
  ...
}

// 表单数据
FormData

// 文件上传
multipart/form-data
```

#### 4.3.2 响应格式
```javascript
{
  "success": true/false,
  "message": "提示信息",
  "data": {},
  "error": {}
}
```

### 4.4 实时通信

#### 4.4.1 SSE（Server-Sent Events）
- 流式输出
- 实时日志
- 进度更新

#### 4.4.2 WebSocket
- 实时对话
- 实时通知

---

## 五、部署架构

### 5.1 Docker部署

#### 5.1.1 多阶段构建
```dockerfile
# 阶段1：前端构建
FROM oven/bun:latest AS builder
WORKDIR /build
COPY web/package.json web/bun.lock ./
RUN bun install
COPY ./web ./
RUN bun run build

# 阶段2：后端构建
FROM golang:alpine AS builder2
ENV GO111MODULE=on CGO_ENABLED=0
WORKDIR /build
ADD go.mod go.sum ./
RUN go mod download
COPY . .
COPY --from=builder /build/dist ./web/dist
RUN go build -o new-api

# 阶段3：运行
FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y ca-certificates tzdata
COPY --from=builder2 /build/new-api /
EXPOSE 3000
ENTRYPOINT ["/new-api"]
```

#### 5.1.2 Docker Compose配置
```yaml
services:
  new-api:
    image: calciumion/new-api:latest
    ports:
      - "3000:3000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    environment:
      - SQL_DSN=postgresql://root:123456@postgres:5432/new-api
      - REDIS_CONN_STRING=redis://redis
      - TZ=Asia/Shanghai
    depends_on:
      - redis
      - postgres
      
  redis:
    image: redis:latest
    restart: always
    
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: new-api
    volumes:
      - pg_data:/var/lib/postgresql/data

volumes:
  pg_data:
```

### 5.2 部署模式

#### 5.2.1 单机部署
- SQLite数据库
- 内置缓存
- 适合小规模使用

#### 5.2.2 分布式部署
- PostgreSQL/MySQL集群
- Redis集群
- 负载均衡
- 适合高并发场景

### 5.3 健康检查
```yaml
healthcheck:
  test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
```

---

## 六、安全架构

### 6.1 认证与授权
- 会话管理
- API Key验证
- OAuth 2.0
- OIDC统一认证
- WebAuthn/Passkey
- 双因素认证（2FA）

### 6.2 数据安全
- 数据加密（CRYPTO_SECRET）
- Token加密存储
- 敏感信息脱敏
- HTTPS传输

### 6.3 访问控制
- RBAC权限模型
- 用户组管理
- 模型访问限制
- IP白名单/黑名单
- 频率限制

### 6.4 安全中间件
- CORS配置
- CSRF防护
- SQL注入防护
- XSS防护
- 敏感词过滤

---

## 七、性能优化

### 7.1 前端优化
- 代码分割（Manual Chunks）
- 懒加载（React.lazy）
- 图片优化
- CDN加速
- 浏览器缓存

### 7.2 后端优化
- 渠道缓存
- 用户缓存
- Token缓存
- 数据库连接池
- 并发控制（gopool）
- 压缩响应（Gzip）

### 7.3 数据库优化
- 索引优化
- 查询优化
- 批量操作
- 读写分离

### 7.4 监控与分析
- Pyroscope性能分析
- pprof调试
- 错误日志
- 访问日志

---

## 八、扩展性设计

### 8.1 渠道扩展
- 适配器模式
- 统一接口规范
- 配置驱动
- 热加载支持

### 8.2 功能扩展
- 插件机制
- Webhook扩展
- 自定义认证
- 自定义中间件

### 8.3 模型扩展
- 模型映射表
- 能力配置
- 价格配置
- 参数转换

---

## 九、开发规范

### 9.1 前端规范
- ESLint代码检查
- Prettier代码格式化
- 组件命名规范
- 文件组织规范
- Git提交规范

### 9.2 后端规范
- Go代码规范（gofmt）
- 错误处理规范
- 日志规范
- API文档规范
- 单元测试

---

## 十、总结

New API 采用现代化的前后端分离架构，后端使用Go语言提供高性能的API服务，前端使用React框架提供良好的用户体验。系统具有良好的扩展性、可维护性和安全性，支持多种AI厂商接口的统一管理和分发。

### 核心优势
1. **高性能**：Go + Gin + GORM，支持高并发
2. **易扩展**：适配器模式，快速接入新厂商
3. **多模型**：支持OpenAI、Claude、Gemini等主流模型
4. **完整功能**：认证、授权、计费、监控一体化
5. **灵活部署**：支持单机和分布式部署
6. **现代化UI**：Semi UI + Tailwind CSS，优秀的用户体验

---

**文档版本**：v1.0
**最后更新**：2026-01-23
**项目地址**：https://github.com/Calcium-Ion/new-api
